<html>
	<head>
		<title>STEVE - Console</title>
		
		<script src="http://www.w3schools.com/lib/w3data.js"></script>
		<script src="http://jeromeetienne.github.io/virtualjoystick.js/virtualjoystick.js"></script>

		<script>
			function updateStatus()
			{
				w3IncludeHTML();
			}
		</script>
		
		<style>
			#container {
			width		: 100%;
			height		: 100%;
			overflow	: hidden;
			padding		: 0;
			margin		: 0;
			-webkit-user-select	: none;
			-moz-user-select	: none;
		}
		</style>
		
		<style type="text/css">
			div.inline { display:inline; }
		</style>
	</head>

	<body>
		<div id="container">
			<h2>STEVE</h2>
			<h4>Robot Console</h4>
			<hr><br>
			Time: <div class="inline" w3-include-html="/time"></div><br>
			CPU Temp: <div class="inline" w3-include-html="/cputemp"></div> Â°C<br>
			Front distance: <div class="inline" w3-include-html="/distance_front"></div> cm<br>
			<input type="button" onclick="updateStatus()" value="Refresh"><br>
			<script>			
				updateStatus();
			</script>
			
			<span id="result"></span>
					
			<script>
				console.log("touchscreen is", VirtualJoystick.touchScreenAvailable() ? "available" : "not available");
		
				var joystick	= new VirtualJoystick({
					container	: document.getElementById('container'),
					mouseSupport	: true,
          limitStickTravel : true,
          stickRadius: 100,
				});
				joystick.addEventListener('touchStart', function(){
					console.log('down')
				})
				joystick.addEventListener('touchEnd', function(){
					console.log('up')
				})
        
        var direction = "0";
        var heading = "0";
        var duty = "0";
        var oldCommand = "0";
        var command = "0";
        
        var pingImg = new Image();

				setInterval(function(){
          if (joystick.up()) direction = "1";
          else if (joystick.down()) direction = "2";
          else direction = "0";
          
          if (joystick.left()) heading = "1";
          else if (joystick.right()) heading = "2";
          else heading = "0";
          
          duty = "0";
          if (Math.sqrt((Math.pow(joystick.deltaX(),2) + Math.pow(joystick.deltaY(),2))) > 0) duty = "1";
          if (Math.sqrt((Math.pow(joystick.deltaX(),2) + Math.pow(joystick.deltaY(),2))) > 20) duty = "2";
          if (Math.sqrt((Math.pow(joystick.deltaX(),2) + Math.pow(joystick.deltaY(),2))) > 40) duty = "3";
          if (Math.sqrt((Math.pow(joystick.deltaX(),2) + Math.pow(joystick.deltaY(),2))) > 60) duty = "4";
          if (Math.sqrt((Math.pow(joystick.deltaX(),2) + Math.pow(joystick.deltaY(),2))) > 80) duty = "5";
          
          command = "/drive/" + direction + "/" + heading + "/" + duty;
          
          if (oldCommand != command)
          {
            pingImg.src = command;
            oldCommand = command;
          }
          
					var outputEl	= document.getElementById('result');
					outputEl.innerHTML	= '<b>Result:</b> '
						+ ' dx:'+joystick.deltaX()
						+ ' dy:'+joystick.deltaY()
						+ (joystick.right()	? ' right'	: '')
						+ (joystick.up()	? ' up'		: '')
						+ (joystick.left()	? ' left'	: '')
						+ (joystick.down()	? ' down' 	: '')
            + ' command = ' + command;
          
				}, 1/30 * 1000);
			</script>
		</div>
	</body>
</html>
